{% extends 'main/layout.html' %}
{% load static %}

{% block title %}Мессенджер{% endblock %}
{% block style %}
<link rel="stylesheet" href="{% static 'main/css/chat.css' %}">
{% endblock %}

{% block content %}
<div><input type="text" id="searchInput" placeholder="Поиск сообщений..." class="searchM2" onkeyup="filterSearch()">
</div>
<div class="yourchatstext2">чат</div>
<div class="krujok2"></div>
<h2 class="username">{{ receiver.email }}</h2>
<div class="rectangle6"></div>
<a href="/chats/" class="close-chat-icon">
    <i class="fa fa-times" style="color: #7396FC; font-size: 20px;"></i> <!-- Иконка крестика -->
</a>
<div id="chat-box">
    {% for message in messages %}
    <div class="message {% if message.sender == user %}sent{% else %}received{% endif %}">
        <p>
            <strong class="username2">{{ message.sender.get_display_name }}</strong>
            <small>{{ message.timestamp|date:"j F H:i" }}</small>
        </p>
        <p class="message-content">
            <!-- Выводим контент сообщения с поддержкой HTML, если есть -->
            {{ message.content|safe }}
        </p> <!-- Контент сообщения -->
        {% if message.image %}
        <img class="message-image" src="{{ message.image.url }}" alt="image">
        {% endif %}
        {% if message.video %}
        <video class="message-video" src="{{ message.video.url }}" controls></video>
        {% endif %}
    </div>
    {% empty %}
    <p>Сообщений пока нет. Начните переписку!</p>
    {% endfor %}
</div>

<!-- Выводим список занятий, кроме тех, что в статусе 'pending' -->
<div class="lessons-list">
    <h3>Запланированные занятия:</h3>
    {% for lesson in lessons %}
    {% if lesson.status != 'pending' %}
    <div class="lesson-item">
        <p><strong>{{ lesson.topic }}</strong> - {{ lesson.date_time|date:"j F, H:i" }}</p>

        <!-- Если занятие можно начать -->
        {% if lesson.status == 'scheduled' %}
        <a href="{% url 'chat_view' receiver.id %}?start_lesson={{ lesson.id }}">
            <button type="button">Начать занятие</button>
        </a>
        {% endif %}

        <!-- Если занятие можно завершить -->
        {% if lesson.status == 'in_progress' %}
        <a href="{% url 'chat_view' receiver.id %}?end_lesson={{ lesson.id }}">
            <button type="button" class="btn btn-warning">Завершить занятие</button>
        </a>
        {% endif %}
    </div>
    {% endif %}
    {% endfor %}
</div>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="recundertextarea"></div>
    <button type="submit" class="startchat2">Отправить</button>
    <div class="message-textarea">
        <input name="content" required>
    </div>
    <div>
        <!-- Для изображения -->
        <label for="image-input" style="cursor: pointer; position: absolute; top: 821px; left: 538px;">
            <i class="fa fa-image" style="color: #7396FC; font-size: 35px;"></i> <!-- Иконка изображения -->
        </label>
        <input id="image-input" class="message-image-input" type="file" name="image" accept="image/*"
               style="display: none;">

        <!-- Для видео -->
        <label for="video-input" style="cursor: pointer; position: absolute; top: 821px; left: 602px;">
            <i class="fa fa-film" style="color: #7396FC; font-size: 35px;"></i> <!-- Иконка пленки для видео -->
        </label>
        <input id="video-input" class="message-video-input" type="file" name="video" accept="video/*"
               style="display: none;">
    </div>
</form>

{% if not lesson %}
<form method="post" action="{% url 'chat_view' receiver.id %}">
    {% csrf_token %}
    <label for="date_time">Дата и время:</label>
    <input type="datetime-local" name="date_time" required><br>

    <label for="duration">Длительность (часы:минуты):</label>
    <input type="time" name="duration" required><br>

    <label for="topic">Тема:</label>
    <input type="text" name="topic" required><br>

    <button type="submit" name="schedule_lesson">Запланировать</button>
</form>
{% endif %}
<div id="notification" class="warningbox hidden">
    <span id="notification-text"></span>
</div>

<script>
    // WebSocket для получения сообщений
    const protocol = window.location.protocol === "https:" ? "wss" : "ws";
    const chatSocket = new WebSocket(`${protocol}://${window.location.host}/ws/chat/{{ receiver.id }}/`);

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        // Создаем новый блок для сообщения
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');
        messageElement.classList.add(data.sender === '{{ user.email }}' ? 'sent' : 'received');

        // Вставляем имя отправителя и сообщение
        messageElement.innerHTML = `
            <p>
                <strong class="username2">${data.sender}</strong>
                <small>${data.timestamp}</small>
            </p>
            <p class="message-content">${data.content}</p>
        `;

        // Если есть изображение или видео, добавляем их
        if (data.image) {
            const imageElement = document.createElement('img');
            imageElement.classList.add('message-image');
            imageElement.src = data.image;
            messageElement.appendChild(imageElement);
        }

        if (data.video) {
            const videoElement = document.createElement('video');
            videoElement.classList.add('message-video');
            videoElement.src = data.video;
            videoElement.controls = true;
            messageElement.appendChild(videoElement);
        }

        // Добавляем новое сообщение в чат
        const chatBox = document.getElementById('chat-box');
        chatBox.appendChild(messageElement);

        // Прокручиваем чат в самый низ
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    chatSocket.onerror = function(e) {
        console.error('WebSocket error observed:', e);
    };

    // Прокрутка чата до последнего сообщения
    document.addEventListener("DOMContentLoaded", function() {
        const chatBox = document.getElementById("chat-box");
        chatBox.scrollTop = chatBox.scrollHeight;  // Устанавливаем прокрутку в самый низ
    });
</script>

<script src="{% static 'main/js/searchmsg.js' %}"></script>

{% endblock %}
