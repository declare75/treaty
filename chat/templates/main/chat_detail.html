{% extends 'main/layout.html' %}
{% load static %}

{% block title %}Мессенджер{% endblock %}
{% block style %}
<link rel="stylesheet" href="{% static 'main/css/chat.css' %}">
{% endblock %}

{% block content %}
<div><input type="text" id="searchInput" placeholder="Поиск сообщений..." class="searchM2" onkeyup="filterSearch()">
</div>
<div class="yourchatstext2">чат</div>
<div class="krujok2"></div>
<h2 class="username">{{ receiver.email }}</h2>
<div class="rectangle6"></div>
<div class="kostyl"></div>
<a href="{% url 'chat_list_view' %}" class="close-chat-icon">
    <i class="fa fa-times" style="color: #7396FC; font-size: 20px;"></i>
</a>
<div id="chat-box" data-last-message-id="{{ last_message_id }}">
    {% for message in messages %}
    <div class="message {% if message.sender == user %}sent{% else %}received{% endif %}"
         data-message-id="{{ message.id }}">
        <p>
            <strong class="username2">{{ message.sender.get_display_name }}</strong>
            <small>{{ message.timestamp|date:"j F H:i" }}</small>
        </p>
        <p class="message-content">
            {{ message.content|safe }}
        </p>
        {% if message.image %}
        <img class="message-image" src="{{ message.image.url }}" alt="image">
        {% endif %}
        {% if message.video %}
        <video class="message-video" src="{{ message.video.url }}" controls></video>
        {% endif %}
    </div>
    {% empty %}
    <p>Сообщений пока нет. Начните переписку!</p>
    {% endfor %}
</div>
{% if user.is_teacher %}
<img src="{% static 'main/img/lessonsbutton.svg' %}" class="lessonsbutton">
<div class="lesson-container">
    <a href="#" class="close-lesson-icon">
        <i class="fa fa-times" style="color: #7396FC; font-size: 20px;"></i>
    </a>


    <div class="lessons-list">
        <div class="plantext">Запланированные занятия</div>
        <div class="backgroundlesson"></div>
        {% for lesson in lessons %}
        {% if lesson.status != 'pending' %}
        <div class="lesson-item">
            <div class="lessonitem">
                <strong>{{ lesson.topic }}</strong> - {{ lesson.date_time|date:"j F, H:i" }}
            </div>
            {% if lesson.status == 'scheduled' %}
            <a href="{% url 'start_lesson' receiver.id lesson.id %}" target="_blank"
               id="start-lesson-link-{{ lesson.id }}"
               style="display: none;"></a>
            <a href="{% url 'meeting' %}?roomID={{ lesson.id }}" target="_blank"
               onclick="document.getElementById('start-lesson-link-{{ lesson.id }}').click();">
                <button class="lessonitem1" type="button">Начать занятие</button>
            </a>
            {% endif %}
            {% if lesson.status == 'in_progress' %}
            <a href="{% url 'end_lesson' receiver.id lesson.id %}">
                <button class="lessonitem2" type="button">Завершить занятие</button>
            </a>
            {% endif %}
        </div>
        {% endif %}
        {% endfor %}
    </div>

    {% if not lesson %}
    <form method="post" action="{% url 'schedule_lesson' receiver.id %}" id="schedule-lesson-form">
        {% csrf_token %}
        <div class="datetime" for="date_time">Дата и время:</div>
        <input class="datetimeinput" type="datetime-local" name="date_time" required><br>
        <div class="dlit" for="duration">Длительность</div>
        <input class="dlitinput" type="time" name="duration" required><br>
        <div class="topic" for="topic">Тема</div>
        <input class="topicinput" type="text" name="topic" required><br>
        <div class="price" for="price">Стоимость</div>
        <input class="priceinput" type="number" name="price" step="0.01" min="0" required><br>
        <button class="submitlesson" type="submit" name="schedule_lesson">Запланировать</button>
        <div class="warningbox hidden" id="successMessage">
            Занятие успешно создано, если поля были заполнены верно!
        </div>
    </form>
    {% endif %}

</div>
{% endif %}
<form method="post" enctype="multipart/form-data" id="message-form" action="{% url 'chat_view' receiver.id %}">
    {% csrf_token %}
    <div class="recundertextarea"></div>
    <button type="submit" class="startchat2">Отправить</button>
    <div class="message-textarea">
        <input name="content" required>
    </div>
    <div>
        <label for="image-input" style="cursor: pointer; position: absolute; top: 821px; left: 538px;">
            <i class="fa fa-image" style="color: #7396FC; font-size: 35px;"></i>
        </label>
        <input id="image-input" class="message-image-input" type="file" name="image" accept="image/*"
               style="display: none;">
        <label for="video-input" style="cursor: pointer; position: absolute; top: 821px; left: 602px;">
            <i class="fa fa-film" style="color: #7396FC; font-size: 35px;"></i>
        </label>
        <input id="video-input" class="message-video-input" type="file" name="video" accept="video/*"
               style="display: none;">
    </div>
</form>

<div id="notification" class="warningbox hidden">
    <span id="notification-text"></span>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('JavaScript loaded'); // Отладка: проверяем загрузку скрипта
    const chatBox = document.getElementById('chat-box');
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notification-text');

    if (!chatBox || !notification || !notificationText) {
        console.error('Error: Missing DOM elements', { chatBox, notification, notificationText });
        return;
    }

    chatBox.scrollTop = chatBox.scrollHeight;

    function fetchMessages() {
        const lastMessageId = chatBox.dataset.lastMessageId || 0;
        fetch(`{% url 'get_messages' receiver.id %}?last_id=${lastMessageId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.messages.length > 0) {
                    data.messages.forEach(message => {
                        const messageElement = document.createElement('div');
                        messageElement.classList.add('message', message.sender === '{{ user.email }}' ? 'sent' : 'received');
                        messageElement.dataset.messageId = message.id;
                        messageElement.innerHTML = `
                            <p>
                                <strong class="username2">${message.sender_name}</strong>
                                <small>${message.timestamp}</small>
                            </p>
                            <p class="message-content">${message.content}</p>
                            ${message.image ? `<img class="message-image" src="${message.image}" alt="image">` : ''}
                            ${message.video ? `<video class="message-video" src="${message.video}" controls></video>` : ''}
                        `;
                        chatBox.appendChild(messageElement);
                        chatBox.dataset.lastMessageId = message.id;
                    });
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            })
            .catch(error => console.error('Error fetching messages:', error));
    }

    setInterval(fetchMessages, 5000);

    document.getElementById('message-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const message = data.message;
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', 'sent');
                messageElement.dataset.messageId = message.id;
                messageElement.innerHTML = `
                    <p>
                        <strong class="username2">${message.sender_name}</strong>
                        <small>${message.timestamp}</small>
                    </p>
                    <p class="message-content">${message.content}</p>
                    ${message.image ? `<img class="message-image" src="${message.image}" alt="image">` : ''}
                    ${message.video ? `<video class="message-video" src="${message.video}" controls></video>` : ''}
                `;
                chatBox.appendChild(messageElement);
                chatBox.dataset.lastMessageId = message.id;
                chatBox.scrollTop = chatBox.scrollHeight;
                this.reset();
            } else {
                notificationText.textContent = data.error || 'Ошибка при отправке сообщения';
                notification.classList.remove('hidden');
                setTimeout(() => notification.classList.add('hidden'), 5000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            notificationText.textContent = 'Ошибка сети при отправке сообщения';
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.add('hidden'), 5000);
        });
    });

    // Обработка URL-параметров для уведомлений
    const urlParams = new URLSearchParams(window.location.search);
    console.log('URL Parameters:', urlParams.toString()); // Отладка: выводим параметры
    if (urlParams.has('confirm_lesson')) {
        console.log('Showing confirm_lesson notification'); // Отладка
        showMessage('Занятие подтверждено! С вашего баланса списана сумма.');
    } else if (urlParams.has('decline_lesson')) {
        console.log('Showing decline_lesson notification'); // Отладка
        showMessage('Занятие отклонено.');
    } else if (urlParams.has('error') && urlParams.get('error') === 'balance') {
        console.log('Showing balance error notification'); // Отладка
        showMessage('Недостаточно средств для оплаты занятия.');
    }

    // Обработчик для submitlesson
    document.getElementById('schedule-lesson-form').addEventListener('submit', function(event) {
        console.log('Schedule lesson form submitted'); // Отладка
        const message = document.getElementById('successMessage');
        if (message) {
            message.classList.remove('hidden');
            setTimeout(() => message.classList.add('hidden'), 5000);
        } else {
            console.error('Error: successMessage element not found');
        }
    });
});

// Определяем showMessage
function showMessage(text) {
    console.log('showMessage called with text:', text); // Отладка
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notification-text');
    console.log('Notification element:', notification); // Отладка
    console.log('Notification text element:', notificationText); // Отладка
    if (notification && notificationText) {
        notificationText.textContent = text;
        notification.classList.remove('hidden');
        console.log('Notification should be visible'); // Отладка
        setTimeout(() => {
            notification.classList.add('hidden');
            console.log('Notification hidden after 5 seconds'); // Отладка
        }, 5000);
    } else {
        console.error('Error: Notification elements not found'); // Отладка
    }
}
</script>
<script>
    const button = document.querySelector('.lessonsbutton');
    const menu = document.querySelector('.lesson-container');
    const closeBtn = document.querySelector('.close-lesson-icon');

    // Открытие/закрытие по клику на кнопку
    button.addEventListener('click', function () {
        button.classList.toggle('active');
        menu.classList.toggle('active');
    });

    // Закрытие по клику на крестик
    closeBtn.addEventListener('click', function (e) {
        e.preventDefault(); // Предотвращаем переход по ссылке
        button.classList.remove('active');
        menu.classList.remove('active');
    });
</script>
<script src="{% static 'main/js/searchmsg.js' %}"></script>
{% endblock %}